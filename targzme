#!/bin/bash


show_help() {
    echo "Usage:    $(basename "$0") \"<folder_pattern>\" [start_dir] [OPTIONS]"
    echo ""
    echo "Description:"
    echo "  Recursively finds subdirectories matching <folder_pattern>,"
    echo "  compresses them into .tar.gz archives alongside the original,"
    echo "  and optionally deletes the original."
    echo "  You should use quotes if using wildcards, e.g.,"
    echo "  $(basename "$0") \"test*\""
    echo ""
    echo "Arguments:"
    echo "  <folder_pattern>  Name or pattern of folders to find."
    echo "  [start_dir]       Optional path to searching from (defaults to CWD)."
    echo ""
    echo "Options:"
    echo "  -d, --delete    Delete the original folder after successful compression."
    echo "  -t, --test      Test mode, lists folders found but takes NO action."
    echo "  -h, --help      Show this help message and exit."
}
if [ $# -eq 0 ]; then
    show_help
    exit 0
fi


FOLDER_PATTERN=""
START_DIR_ARG=""
SHOULD_DELETE=false
DRY_RUN=false


# Parse Arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help)
            show_help
            exit 0
            ;;
        -d|--delete)
            SHOULD_DELETE=true
            ;;
        -t|--test)
            DRY_RUN=true
            ;;
        -*)
            echo "!!! ERROR: Unknown option: $1"
            echo "Try '$(basename "$0") --help' for more information."
            exit 1
            ;;
        *)
            if [ -z "$FOLDER_PATTERN" ]; then
                FOLDER_PATTERN="$1"
            elif [ -z "$START_DIR_ARG" ]; then
                START_DIR_ARG="$1"
            else
                echo "!!! ERROR: Too many arguments!"
                echo "Target Pattern?:  $FOLDER_PATTERN"
                echo "Starting Path?:   $START_DIR_ARG"
                echo "???:              $1"
                echo "TIP: Did you use a wildcard without quotes? Try \"$FOLDER_PATTERN*\""
                exit 1
            fi
            ;;
    esac
    shift
done


# Check the input
if [ -z "$FOLDER_PATTERN" ]; then
    echo "!!! ERROR: No folder name provided."
    exit 1
fi

if [ -z "$START_DIR_ARG" ]; then
    START_DIR="."
else  # The argument itself, or "." if it's an empty string
    START_DIR="${START_DIR_ARG:-.}"
fi

if [ ! -d "$START_DIR" ]; then
    echo "!!! ERROR: The directory '$START_DIR' does not exist."
    exit 1
fi


ABS_START_PATH=$(cd "$START_DIR" 2>/dev/null && pwd)


echo ""
echo "Target: '$FOLDER_PATTERN'"
echo "Path:   '$ABS_START_PATH'"

if [ "$DRY_RUN" = true ]; then
    echo "Mode:    TESTING (no changes will be made)"
elif [ "$SHOULD_DELETE" = true ]; then
    echo "Mode:    DELETE (original folders will be removed after successful compression)"
else
    echo "Mode:    SAFE (original folders will be kept)"
fi
echo ""


find "$START_DIR" -type d -name "$FOLDER_PATTERN" -prune 2>/dev/null | while IFS= read -r DIR_PATH
do
    # Ignore base folder
    ABS_FOUND_PATH=$(cd "$DIR_PATH" 2>/dev/null && pwd)
    if [[ "$ABS_START_PATH" == "$ABS_FOUND_PATH" ]]; then
        continue
    fi
    # Safety check
    if [[ "$DIR_PATH" == "." || "$DIR_PATH" == "/" ]]; then
        continue
    fi

    echo "  Found: $DIR_PATH"

    if [ "$DRY_RUN" = true ]; then
        continue
    fi

    PARENT_DIR=$(dirname "$DIR_PATH")
    ACTUAL_DIR_NAME=$(basename "$DIR_PATH")
    ARCHIVE_NAME="$PARENT_DIR/$ACTUAL_DIR_NAME.tar.gz"

    if tar -czf "$ARCHIVE_NAME" -C "$PARENT_DIR" "$ACTUAL_DIR_NAME"; then
        echo "    Compressed to: $ARCHIVE_NAME"
        if [ "$SHOULD_DELETE" = true ]; then
            if rm -rf "$DIR_PATH"; then
                echo "    Deleted original folder"
            else
                echo "    !!! WARNING: Deletion failed for $DIR_PATH"
            fi
        fi

    else
        echo "    !!! ERROR: Failed to compress $DIR_PATH. Nothing was deleted."
    fi
done

echo ""

